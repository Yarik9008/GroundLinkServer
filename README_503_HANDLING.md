# Обработка ошибки 503 (Service Unavailable)

## Описание

Добавлена автоматическая обработка ошибки **503 Service Unavailable** во всех HTTP-запросах к серверу EUS с использованием **экспоненциальной задержки** (exponential backoff).

## Где применяется

### 1. Получение списка логов (`fetch_logs_page`)
- **Функция:** `fetch_logs_page(url, st, headers, max_retries=3)`
- **Использование:** Загрузка HTML страницы со списком доступных логов
- **Стратегия:** При ошибке 503 повторяет запрос до 3 раз с задержками 2, 4, 8 секунд

### 2. Асинхронная загрузка логов (`download_single_log_async`)
- **Функция:** `download_single_log_async(...)`
- **Использование:** Параллельная загрузка лог-файлов через aiohttp
- **Стратегия:** При ошибке 503 повторяет запрос до 2 раз с задержками 2, 4 секунды

### 3. Синхронная загрузка логов (`_download_logs_sync`)
- **Функция:** `_download_logs_sync(...)`
- **Использование:** Последовательная загрузка лог-файлов (fallback)
- **Стратегия:** При ошибке 503 повторяет запрос до 2 раз с задержками 2, 4 секунды

## Алгоритм работы

```
Попытка 1: Запрос → 503 → Ожидание 2 сек
Попытка 2: Запрос → 503 → Ожидание 4 сек
Попытка 3: Запрос → 503 → Ожидание 8 сек (только для fetch_logs_page)
Попытка N: Запрос → Успех или финальная ошибка
```

### Экспоненциальная задержка

```python
delay = 2 ** attempt  # 2, 4, 8, 16, ...
```

**Примеры:**
- Попытка 1: задержка 2 секунды
- Попытка 2: задержка 4 секунды
- Попытка 3: задержка 8 секунд

## Поведение для других ошибок

### HTTP ошибки (404, 500, и др.)
- **Действие:** Немедленный выброс исключения без повторов
- **Причина:** Эти ошибки указывают на проблемы с данными, а не временную недоступность

### Сетевые ошибки (timeout, connection)
- **Действие:** Повтор с фиксированной задержкой 1 секунда
- **Причина:** Временные сетевые проблемы

## Примеры из логов

### Успешное восстановление после 503
```
2026-01-09 12:22:54 - WARNING - Ошибка 503 (Service Unavailable) для 'oper', попытка 1/3. Повтор через 2 сек...
2026-01-09 12:22:56 - WARNING - Ошибка 503 (Service Unavailable) для 'oper', попытка 2/3. Повтор через 4 сек...
2026-01-09 12:23:00 - INFO - Успешно загружена страница для 'oper'
```

### Превышение лимита попыток
```
2026-01-09 12:23:00 - WARNING - Ошибка 503 (Service Unavailable) для 'reg', попытка 1/3. Повтор через 2 сек...
2026-01-09 12:23:02 - WARNING - Ошибка 503 (Service Unavailable) для 'reg', попытка 2/3. Повтор через 4 сек...
2026-01-09 12:23:06 - WARNING - Ошибка 503 (Service Unavailable) для 'reg', попытка 3/3. Повтор через 8 сек...
2026-01-09 12:23:14 - ERROR - Превышено количество попыток для 'reg' после 3 попыток
```

## Тестирование

Запустите тест для проверки работы обработки 503:

```bash
cd /root/lorett/GroundLinkMonitorServer
python3 test_503_handling.py
```

## Преимущества

1. **Автоматическое восстановление** - не требуется ручное вмешательство при временных сбоях
2. **Экспоненциальная задержка** - снижает нагрузку на сервер при его восстановлении
3. **Логирование** - все попытки фиксируются в логах для анализа
4. **Селективная обработка** - только 503 получает специальную обработку, другие ошибки обрабатываются быстро

## Конфигурация

Максимальное количество попыток задается в коде:
- `fetch_logs_page`: `max_retries=3` (по умолчанию)
- `download_single_log_async`: `max_retries=2` (по умолчанию)
- `_download_logs_sync`: `max_retries=2` (жестко закодировано)

При необходимости можно изменить эти значения в коде функций.
