# GroundLinkMonitorServer

Сервер мониторинга наземных станций приёма спутниковых пролётов: загрузка логов с портала EUS, анализ пролётов, учёт коммерческих пролётов из Telegram, формирование отчётов и отправка сводки по email.

## Возможности

- **Загрузка логов и графиков** — с портала EUS по диапазону дат (станции, пролёты, лог-файлы, PNG-графики).
- **Анализ пролётов** — разбор логов (заголовок, SNR, окно приёма), определение успешных/пустых пролётов.
- **База данных** — SQLite: пролёты, дневная статистика по станциям, коммерческие пролёты (заказанные и принятые).
- **Telegram** — синхронизация списка коммерческих пролётов из канала (заказ сессий приёма).
- **Графики** — % пустых пролётов за 7 дней (общий и по станциям), % непринятых коммерческих за 7 дней.
- **Email-сводка** — HTML-письмо со статистикой по станциям, таблицей коммерческих пролётов, графиками и списком непринятых коммерческих с ссылками на графики.

## Структура проекта

| Файл / каталог | Назначение |
|----------------|------------|
| `GroundLinkServer.py` | Точка входа: оркестрация загрузки, анализа, БД, отчётов и email. |
| `EusLogDownloader.py` | Клиент портала EUS: HTML, список станций/пролётов, скачивание логов и рендер графиков. |
| `PassAnalyzer.py` | Анализ лог-файлов пролётов (заголовок, SNR, окно приёма). |
| `SatPass.py` | Модель данных пролёта (станция, спутник, дата/время, SNR, пути к логу/графику). |
| `DbManager.py` | SQLite: схема, пролёты, дневная статистика, коммерческие пролёты (CRUD и отчёты). |
| `GraphGenerator.py` | Построение PNG-графиков по данным БД (7-дневные тренды). |
| `EmailClient.py` | Формирование HTML-письма и отправка по SMTP (вложения, inline-изображения). |
| `TelClient.py` | Telegram (telethon): чтение канала и парсинг коммерческих пролётов. |
| `Logger.py` | Логирование. |
| `config.json` | Конфигурация: Telegram, email, станции для письма, алиасы станций/спутников. |
| `passes_logs/` | Скачанные лог-файлы (по структуре год/месяц/день/станция). |
| `report/` | Сгенерированные графики (год/месяц/день). |
| `server_logs/` | Логи работы сервера. |

## Зависимости

- Python 3.10+
- **aiohttp** — асинхронная загрузка с EUS.
- **beautifulsoup4** — разбор HTML портала.
- **telethon** — Telegram API (для синхронизации коммерческих пролётов).
- **matplotlib** — построение графиков.
- **colorama** — цветной вывод в консоль (опционально).

Установка (пример):

```bash
pip install aiohttp beautifulsoup4 telethon matplotlib colorama
```

## Конфигурация (`config.json`)

- **telegram** — `api_id`, `api_hash`, `channel`, `session`; `station_aliases`, `satellite_aliases` для маппинга коротких имён из сообщений в имена станций/спутников в системе.
- **report_dir** — каталог для графиков (например, `report`).
- **email** — `enabled`, SMTP-параметры, отправитель, получатели, тема, `attach_report`, `debug_recipient`.
- **stations_for_email** — список станций, по которым включать блок в письме и строить графики.

## Запуск

```bash
python GroundLinkServer.py [start_date] [end_date] [--sch] [--off-email] [--debag-email]
```

- **start_date**, **end_date** — даты в формате `YYYYMMDD`. Если не указаны — обрабатывается только текущий день (UTC).
- **--sch** — режим по расписанию: ожидание до 00:00 UTC, затем один прогон за текущий день (удобно для cron).
- **--off-email** — не отправлять email.
- **--debag-email** — отладочная отправка: письмо уходит только на `debug_recipient` из конфига.

Примеры:

```bash
# Только сегодня (UTC), с отправкой письма
python GroundLinkServer.py

# Диапазон дат, без email
python GroundLinkServer.py 20260101 20260115 --off-email

# По расписанию (каждую полночь UTC)
python GroundLinkServer.py --sch
```

## Сервис systemd

Проект содержит unit-файл `groundlinkserver.service` для автозапуска в режиме планировщика (`--sch`).

Установка и запуск:

```bash
sudo cp /root/lorett/GroundLinkServer/groundlinkserver.service /etc/systemd/system/groundlinkserver.service
sudo systemctl daemon-reload
sudo systemctl enable groundlinkserver.service
sudo systemctl start groundlinkserver.service
```

Проверка статуса и логи:

```bash
sudo systemctl status groundlinkserver.service --no-pager
journalctl -u groundlinkserver.service -n 100 --no-pager
```

Остановка и отключение:

```bash
sudo systemctl stop groundlinkserver.service
sudo systemctl disable groundlinkserver.service
```

## Логика работы (кратко)

1. При старте `main()` выполняется синхронизация коммерческих пролётов из Telegram (`TelClient.run_comm_passes_sync()`), результат записывается в БД (`DbManager.replace_commercial_passes`).
2. Загружается HTML портала EUS за заданный диапазон дат, получается список станций и пролётов.
3. Скачиваются лог-файлы в `passes_logs/`, каждый лог анализируется (`PassAnalyzer`), формируются объекты `SatPas` с метриками и путями.
4. Пролёты пачкой записываются в БД (`add_passes_batch`); обновляется дневная статистика и связь с коммерческими пролётами (если применимо).
5. Для каждого дня в диапазоне строится сводка по станциям, генерируются графики (общий и по станциям за 7 дней, коммерческие за 7 дней), при включённой отправке — формируется письмо со статистикой, таблицей коммерческих пролётов, списком непринятых коммерческих и графиками, затем отправка по SMTP.

## База данных

Файл по умолчанию: `groundlink.db`. В БД хранятся: пролёты (в т.ч. ссылки на логи/графики), дневная статистика по станциям, коммерческие пролёты (дата, станция, спутник, время сессии, признак приёма). Методы `DbManager` позволяют получать число запланированных/принятых коммерческих пролётов на день (с опциональной отсечкой по текущему времени UTC), статистику по станциям и список непринятых коммерческих с URL графиков для письма.

## Лицензия и авторство

Проект для внутреннего использования. При необходимости укажите свою лицензию и контакты.
